- name: Install base packages
  apt:
    name:
      - nginx
      - libnginx-mod-http-modsecurity
      - docker.io
      - nftables
    state: present
    update_cache: yes

- name: Install dependencies for Docker Repo
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present

- name: Add Docker official GPG key
  apt_key:
    url: https://download.docker.com
    state: present

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch=amd64] https://download.docker.com {{ ansible_distribution_release }} stable"
    state: present
    update_cache: yes

- name: Install Docker and Compose Plugin
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present


- name: Add Zeek GPG key
  get_url:
    url: https://download.opensuse.org/repositories/security:zeek/xUbuntu_{{ ansible_distribution_version }}/Release.key
    dest: /usr/share/keyrings/zeek-archive-keyring.gpg
    mode: '0644'

- name: Add Zeek repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/zeek-archive-keyring.gpg] https://download.opensuse.org/repositories/security:/zeek/xUbuntu_{{ ansible_distribution_version }}/ /"
    state: present

- name: Install Zeek
  apt:
    name: zeek
    state: present
    update_cache: yes    

- name: Add Elastic GPG key
  ansible.builtin.get_url:
    url: https://artifacts.elastic.co/GPG-KEY-elasticsearch
    dest: /usr/share/keyrings/elastic.gpg
    mode: '0644'

- name: Add Elastic repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/elastic.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main"
    state: present

- name: Install Filebeat
  ansible.builtin.apt:
    name: filebeat
    state: present
    update_cache: yes


- name: Create ELK directory
  file:
    path: /opt/elk
    state: directory

- name: Deploy docker-compose.yml for ELK
  copy:
    dest: /opt/elk/docker-compose.yml
    content: |
      services:
        elasticsearch:
          image: docker.elastic.co/elasticsearch/elasticsearch:{{ elk_version }}
          environment:
            - discovery.type=single-node
            - xpack.security.enabled=false
          ports:
            - "9200:9200"

        kibana:
          image: docker.elastic.co/kibana/kibana:{{ elk_version }}
          environment:
            - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
          ports:
            - "5601:5601"

- name: Start ELK stack
  shell: docker compose up -d
  args:
    chdir: /opt/elk

- name: Configure Zeek interface
  lineinfile:
    path: /opt/zeek/etc/node.cfg
    regexp: '^interface='
    line: "interface={{ zeek_interface }}"

- name: Deploy Zeek
  shell: zeekctl deploy

- name: Configure Filebeat
  copy:
    dest: /etc/filebeat/filebeat.yml
    content: |
      filebeat.inputs:
        - type: filestream
          paths:
            - /opt/zeek/logs/current/*.log
            - /var/log/nginx/*.log

      output.elasticsearch:
        hosts: ["http://localhost:9200"]

      setup.kibana:
        host: "http://localhost:5601"

- name: Enable and start Filebeat
  systemd:
    name: filebeat
    enabled: yes
    state: started

- name: Install OWASP CRS
  apt:
    name: modsecurity-crs
    state: present

- name: Enable ModSecurity
  lineinfile:
    path: /etc/modsecurity/modsecurity.conf
    regexp: '^SecRuleEngine'
    line: 'SecRuleEngine On'

- name: Configure Nginx rate limiting
  copy:
    dest: /etc/nginx/conf.d/waf.conf
    content: |
      limit_req_zone $binary_remote_addr zone=req_per_ip:10m rate=5r/s;

      server {
        listen 80;
        location / {
          limit_req zone=req_per_ip burst=20 nodelay;
          proxy_pass http://127.0.0.1:8080;
        }
      }

- name: Restart Nginx
  service:
    name: nginx
    state: restarted

- name: Configure nftables SYN rate limit
  shell: |
    nft add table inet filter || true
    nft add chain inet filter input { type filter hook input priority 0 \; } || true
    nft add rule inet filter input tcp flags syn tcp dport 80 limit rate 50/second accept || true
    nft add rule inet filter input tcp flags syn tcp dport 80 drop || true




